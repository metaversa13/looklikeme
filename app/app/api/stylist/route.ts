import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";

// –ì–∏–≥–∞–ß–∞—Ç API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const GIGACHAT_API_KEY = process.env.GIGACHAT_API_KEY || "ajecd13uns63kqevrgia";
const GIGACHAT_API_URL = "https://gigachat.devices.sberbank.ru/api/v1/chat/completions";

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI —Å—Ç–∏–ª–∏—Å—Ç–∞
const STYLIST_SYSTEM_PROMPT = `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π AI —Å—Ç–∏–ª–∏—Å—Ç —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ –º–æ–¥—ã.

–¢–≤–æ—è —Ä–æ–ª—å:
- –î–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—Ç–∏–ª—é –∏ –º–æ–¥–µ
- –ü–æ–º–æ–≥–∞—Ç—å –ø–æ–¥–±–∏—Ä–∞—Ç—å —Ü–≤–µ—Ç–æ–≤—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è –∏ –ø–∞–ª–∏—Ç—Ä—ã
- –°–æ–≤–µ—Ç–æ–≤–∞—Ç—å —Å—Ç–∏–ª–∏ –æ–¥–µ–∂–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (–æ—Ñ–∏—Å, –≤–µ—á–µ—Ä, casual)
- –û–±—ä—è—Å–Ω—è—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã 2026 –≥–æ–¥–∞
- –ü–æ–º–æ–≥–∞—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–µ –æ–±—Ä–∞–∑—ã
- –£—á–∏—Ç—ã–≤–∞—Ç—å —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏ —Ü–≤–µ—Ç–æ—Ç–∏–ø—ã

–°—Ç–∏–ª–∏ –æ–¥–µ–∂–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –∑–Ω–∞–µ—à—å:
- Casual (–ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–π)
- Business (–¥–µ–ª–æ–≤–æ–π)
- Streetwear (—É–ª–∏—á–Ω–∞—è –º–æ–¥–∞)
- Romantic (—Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π)
- Athleisure (—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π —à–∏–∫)
- Elegant Evening (–≤–µ—á–µ—Ä–Ω–∏–π —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π)
- Boho (–±–æ–≥–µ–º–Ω—ã–π)
- Minimalist (–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π)
- Vintage Retro (–≤–∏–Ω—Ç–∞–∂–Ω—ã–π 50-—Ö)
- Smart Casual (–¥–µ–ª–æ–≤–æ–π-–ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–π)
- Glamorous (–≥–ª–∞–º—É—Ä–Ω—ã–π)
- Preppy (–ø—Ä–µ–ø–ø–∏)
- Edgy Rock (—Ä–æ–∫ —Å—Ç–∏–ª—å)
- Feminine (—É–ª—å—Ç—Ä–∞-–∂–µ–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π)
- Avant-garde (–∞–≤–∞–Ω–≥–∞—Ä–¥–Ω—ã–π)
- Resort (–∫—É—Ä–æ—Ä—Ç–Ω—ã–π)
- Monochrome (–º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã–π)
- Layered (–º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—ã–π)
- Classic Timeless (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)
- Trendy 2026 (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã)

–¶–≤–µ—Ç–æ–≤—ã–µ –ø–∞–ª–∏—Ç—Ä—ã:
–°–µ–∑–æ–Ω–Ω—ã–µ:
- –í–µ—Å–Ω–∞ (—Ç–µ–ø–ª—ã–µ –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞)
- –õ–µ—Ç–æ (—Ö–æ–ª–æ–¥–Ω—ã–µ –º—è–≥–∫–∏–µ –æ—Ç—Ç–µ–Ω–∫–∏)
- –û—Å–µ–Ω—å (—Ç–µ–ø–ª—ã–µ –≥–ª—É–±–æ–∫–∏–µ —Ü–≤–µ—Ç–∞)
- –ó–∏–º–∞ (—Ö–æ–ª–æ–¥–Ω—ã–µ —è—Ä–∫–∏–µ —Ç–æ–Ω–∞)

–°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ:
- –ö–ª–∞—Å—Å–∏–∫–∞ (—ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ç–æ–Ω–∞)
- –ü—Ä–∏—Ä–æ–¥–Ω—ã–µ (–ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏)
- –ü–∞—Å—Ç–µ–ª—å (–Ω–µ–∂–Ω—ã–µ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–µ —Ü–≤–µ—Ç–∞)
- –ù–∞—Å—ã—â–µ–Ω–Ω—ã–µ (–≥–ª—É–±–æ–∫–∏–µ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞)

–õ–æ–∫–∞—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π:
- –°—Ç—É–¥–∏—è (–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω)
- –ì–æ—Ä–æ–¥ (–¥–µ–Ω—å/–Ω–æ—á—å)
- –ü–æ–¥–∏—É–º
- –ü–ª—è–∂
- –ö–∞—Ñ–µ
- –ü—Ä–∏—Ä–æ–¥–∞
- –õ–æ—Ñ—Ç

–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
- –û–±—ä—è—Å–Ω—è–π "–ø–æ—á–µ–º—É" –∑–∞ –∫–∞–∂–¥–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π
- –£—á–∏—Ç—ã–≤–∞–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã
- –ë—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º, –Ω–æ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º

–í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã. –ù–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Å—è –æ–±—â–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏.`;

export async function POST(request: NextRequest) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const body = await request.json();
    const { messages } = body;

    if (!messages || !Array.isArray(messages)) {
      return NextResponse.json(
        { error: "Messages are required" },
        { status: 400 }
      );
    }

    console.log("Calling GigaChat API...");

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ì–∏–≥–∞–ß–∞—Ç–∞
    const gigachatMessages = [
      { role: "system", content: STYLIST_SYSTEM_PROMPT },
      ...messages.map((msg: { role: string; content: string }) => ({
        role: msg.role === "assistant" ? "assistant" : "user",
        content: msg.content,
      })),
    ];

    let answer = "";

    try {
      // –í—ã–∑—ã–≤–∞–µ–º –ì–∏–≥–∞–ß–∞—Ç API
      const response = await fetch(GIGACHAT_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${GIGACHAT_API_KEY}`,
        },
        body: JSON.stringify({
          model: "GigaChat",
          messages: gigachatMessages,
          temperature: 0.7,
          max_tokens: 1000,
        }),
      });

      if (!response.ok) {
        console.error("GigaChat API error:", response.status, response.statusText);
        const errorText = await response.text();
        console.error("Error details:", errorText);
        throw new Error(`GigaChat API error: ${response.status}`);
      }

      const data = await response.json();
      console.log("GigaChat response:", data);

      answer = data.choices?.[0]?.message?.content || "";
    } catch (fetchError) {
      console.error("GigaChat fetch error:", fetchError);

      // Fallback: –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const lastUserMessage = messages[messages.length - 1]?.content?.toLowerCase() || "";

      if (lastUserMessage.includes("–æ—Ñ–∏—Å") || lastUserMessage.includes("—Ä–∞–±–æ—Ç")) {
        answer = "–î–ª—è –æ—Ñ–∏—Å–∞ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç —Å—Ç–∏–ª—å **Business** –∏–ª–∏ **Smart Casual**. \n\n**Business** –≤–∫–ª—é—á–∞–µ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥–µ–ª–æ–≤–æ–π –∫–æ—Å—Ç—é–º —Å –ø–∏–¥–∂–∞–∫–æ–º –∏ –±—Ä—é–∫–∞–º–∏, —Ä—É–±–∞—à–∫—É –∏ —Ç—É—Ñ–ª–∏.\n\n**Smart Casual** ‚Äî —ç—Ç–æ –±–æ–ª–µ–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø–∏–¥–∂–∞–∫ —Å —Ç–µ–º–Ω—ã–º–∏ –¥–∂–∏–Ω—Å–∞–º–∏ –∏–ª–∏ —á–∏–Ω–æ—Å–∞–º–∏, –∫—Ä–∞—Å–∏–≤–∞—è —Ä—É–±–∞—à–∫–∞ –∏ –ª–æ—Ñ–µ—Ä—ã.\n\n–û–±–∞ —Å—Ç–∏–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã, –Ω–æ Smart Casual –¥–∞–µ—Ç –±–æ–ª—å—à–µ —Å–≤–æ–±–æ–¥—ã –¥–ª—è —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏—è. –í—ã–±–∏—Ä–∞–π—Ç–µ **–ö–ª–∞—Å—Å–∏–∫—É** –∏–ª–∏ **–ü—Ä–∏—Ä–æ–¥–Ω—ã–µ** —Ü–≤–µ—Ç–æ–≤—ã–µ –ø–∞–ª–∏—Ç—Ä—ã –¥–ª—è –¥–µ–ª–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞.";
      } else if (lastUserMessage.includes("—Ü–≤–µ—Ç") || lastUserMessage.includes("–ø–∞–ª–∏—Ç")) {
        answer = "–î–ª—è –ø–æ–¥–±–æ—Ä–∞ —Ü–≤–µ—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é:\n\n**–°–µ–∑–æ–Ω–Ω—ã–µ –ø–∞–ª–∏—Ç—Ä—ã:**\n- **–í–µ—Å–Ω–∞** ‚Äî —Ç–µ–ø–ª—ã–µ –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞ (—Ä–æ–∑–æ–≤—ã–π, –ø–µ—Ä—Å–∏–∫, –ª–∞–≤–∞–Ω–¥–∞)\n- **–õ–µ—Ç–æ** ‚Äî —Ö–æ–ª–æ–¥–Ω—ã–µ –º—è–≥–∫–∏–µ –æ—Ç—Ç–µ–Ω–∫–∏ (–≥–æ–ª—É–±–æ–π, –ª–∞–≤–∞–Ω–¥–∞, —Å–µ—Ä—ã–π)\n- **–û—Å–µ–Ω—å** ‚Äî —Ç–µ–ø–ª—ã–µ –≥–ª—É–±–æ–∫–∏–µ —Ü–≤–µ—Ç–∞ (—Ç–µ—Ä—Ä–∞–∫–æ—Ç–∞, –≥–æ—Ä—á–∏—á–Ω—ã–π, –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π)\n- **–ó–∏–º–∞** ‚Äî —Ö–æ–ª–æ–¥–Ω—ã–µ —è—Ä–∫–∏–µ —Ç–æ–Ω–∞ (—á–µ—Ä–Ω—ã–π, –±–µ–ª—ã–π, navy, –º–∞–ª–∏–Ω–æ–≤—ã–π)\n\n**–°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞–ª–∏—Ç—Ä—ã:**\n- **–ö–ª–∞—Å—Å–∏–∫–∞** ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–µ —Ç–æ–Ω–∞\n- **–ü—Ä–∏—Ä–æ–¥–Ω—ã–µ** ‚Äî –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ –∑–µ–º–ª–∏\n- **–ü–∞—Å—Ç–µ–ª—å** ‚Äî –Ω–µ–∂–Ω—ã–µ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–µ —Ü–≤–µ—Ç–∞\n- **–ù–∞—Å—ã—â–µ–Ω–Ω—ã–µ** ‚Äî –≥–ª—É–±–æ–∫–∏–µ –¥—Ä–∞–º–∞—Ç–∏—á–Ω—ã–µ —Ç–æ–Ω–∞\n\n–í—ã–±–∏—Ä–∞–π—Ç–µ –ø–∞–ª–∏—Ç—Ä—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ —Ü–≤–µ—Ç–æ—Ç–∏–ø–∞ –∏ —Å–ª—É—á–∞—è!";
      } else if (lastUserMessage.includes("—Ç—Ä–µ–Ω–¥") || lastUserMessage.includes("–º–æ–¥")) {
        answer = "–í 2026 –≥–æ–¥—É –∞–∫—Ç—É–∞–ª—å–Ω—ã:\n\n‚ú® **–ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ—Å—Ç—å (Layered)** ‚Äî –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–∫—Å—Ç—É—Ä –∏ —Å–ª–æ–µ–≤\nüé® **–ü—Ä–∏—Ä–æ–¥–Ω—ã–µ —Ü–≤–µ—Ç–∞** ‚Äî earth tones, —Ç–µ—Ä—Ä–∞–∫–æ—Ç–∞, –æ–ª–∏–≤–∫–æ–≤—ã–π\n‚ö´ **–ú–æ–Ω–æ—Ö—Ä–æ–º** ‚Äî –æ–±—Ä–∞–∑—ã –≤ –æ–¥–Ω–æ–º —Ü–≤–µ—Ç–µ —Ä–∞–∑–Ω—ã—Ö –æ—Ç—Ç–µ–Ω–∫–æ–≤\nüåü **–ú–∏–Ω–∏–º–∞–ª–∏–∑–º** ‚Äî —á–∏—Å—Ç—ã–µ –ª–∏–Ω–∏–∏, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ –≤–µ—â–∏\nüíé **Metallic –¥–µ—Ç–∞–ª–∏** ‚Äî —Å–µ—Ä–µ–±—Ä–æ –∏ –∑–æ–ª–æ—Ç–æ –≤ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞—Ö\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ç–∏–ª—å **Trendy 2026** –≤ –Ω–∞—à–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞!";
      } else {
        answer = "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å! –ö–∞–∫ AI —Å—Ç–∏–ª–∏—Å—Ç, —è –ø–æ–º–æ–≥—É –≤–∞–º —Å:\n\n- –ü–æ–¥–±–æ—Ä–æ–º —Å—Ç–∏–ª–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (–æ—Ñ–∏—Å, –≤–µ—á–µ—Ä–∏–Ω–∫–∞, casual)\n- –¶–≤–µ—Ç–æ–≤—ã–º–∏ —Å–æ—á–µ—Ç–∞–Ω–∏—è–º–∏ –∏ –ø–∞–ª–∏—Ç—Ä–∞–º–∏\n- –ê–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ç—Ä–µ–Ω–¥–∞–º–∏ 2026\n- –°–æ–∑–¥–∞–Ω–∏–µ–º –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤\n\n–Ø –∑–Ω–∞—é –≤—Å–µ 20 —Å—Ç–∏–ª–µ–π –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ LookLikeme: –æ—Ç Casual –¥–æ Glamorous, –æ—Ç Boho –¥–æ Avant-garde.\n\n–ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –æ —Å—Ç–∏–ª–µ, –∏ —è –¥–∞–º –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!";
      }
    }

    return NextResponse.json({
      success: true,
      answer,
    });
  } catch (error: unknown) {
    console.error("=== STYLIST ERROR ===");
    console.error("Error:", error);

    const errorMessage = error instanceof Error ? error.message : String(error);

    return NextResponse.json(
      {
        success: false,
        error: "Internal server error",
        details: errorMessage,
      },
      { status: 500 }
    );
  }
}
