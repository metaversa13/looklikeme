# Настройка YooKassa (Платежи)

## 1. Регистрация в YooKassa

1. Перейдите на [yookassa.ru](https://yookassa.ru)
2. Зарегистрируйтесь или войдите через Яндекс ID
3. Создайте магазин (заполните данные о вашем бизнесе)
4. Дождитесь модерации (обычно 1-2 рабочих дня)

## 2. Получение ключей API

1. Войдите в личный кабинет YooKassa
2. Перейдите в раздел **Настройки** → **Ключи API**
3. Создайте новый секретный ключ
4. Скопируйте:
   - `shopId` (ID магазина)
   - `Секретный ключ` (Secret Key)

## 3. Настройка переменных окружения

Добавьте в `.env.local`:

```env
YOOKASSA_SHOP_ID="ваш-shop-id"
YOOKASSA_SECRET_KEY="ваш-секретный-ключ"
```

## 4. Настройка Webhook

Для получения уведомлений об оплате нужно настроить webhook:

### В личном кабинете YooKassa:

1. Перейдите в **Настройки** → **Уведомления**
2. Добавьте HTTP-уведомление:
   - **URL**: `https://ваш-домен.ru/api/payments/webhook`
   - **События**: `payment.succeeded`
   - **Метод**: `POST`
   - **Формат**: `JSON`

### Для локальной разработки:

Используйте ngrok для тестирования webhook локально:

```bash
# Установите ngrok
npm install -g ngrok

# Запустите туннель
ngrok http 3000

# Используйте предоставленный URL в настройках webhook
# Например: https://abc123.ngrok.io/api/payments/webhook
```

## 5. Тестовые платежи

YooKassa предоставляет тестовый магазин для проверки интеграции:

### Тестовые данные карты:

- **Номер карты**: `5555 5555 5555 4444`
- **Срок действия**: любая дата в будущем
- **CVC**: любые 3 цифры
- **3-D Secure код**: `12345`

### Статусы тестовых платежей:

- Карта `4444 4444 4444 4448` → успешная оплата
- Карта `5555 5555 5555 4477` → отклонённый платёж

## 6. Проверка интеграции

1. Запустите проект: `npm run dev`
2. Перейдите на `/pricing`
3. Нажмите "Оформить подписку"
4. Заполните тестовые данные карты
5. Проверьте:
   - Платёж создан в YooKassa
   - Webhook получен (проверьте логи)
   - Подписка активирована в БД
   - Редирект на `/payments/success`

## 7. Безопасность

⚠️ **ВАЖНО:**

- **НЕ коммитьте** `.env.local` в Git
- Используйте разные ключи для dev/prod
- Включите IP-фильтрацию для webhook в продакшене
- Настройте HTTPS для продакшена (webhook требует HTTPS)

## 8. Продакшен

Перед запуском в продакшен:

1. Пройдите модерацию магазина в YooKassa
2. Настройте webhook с продакшен URL (HTTPS обязателен)
3. Включите 3-D Secure
4. Настройте уведомления о платежах
5. Подключите налоговую систему (54-ФЗ)

## Структура API

### `/api/payments/create` (POST)

Создаёт платёж в YooKassa и возвращает URL для оплаты.

**Request:**
```json
{
  "planId": "PREMIUM" | "LIFETIME"
}
```

**Response:**
```json
{
  "paymentUrl": "https://yoomoney.ru/checkout/payments/...",
  "purchaseId": "clxxx..."
}
```

### `/api/payments/webhook` (POST)

Обрабатывает уведомления от YooKassa о статусе платежа.

**Webhook payload:**
```json
{
  "event": "payment.succeeded",
  "object": {
    "id": "payment-id",
    "status": "succeeded",
    "metadata": {
      "purchaseId": "clxxx...",
      "userId": "clxxx...",
      "planId": "PREMIUM"
    }
  }
}
```

## Тарифы

| План | Цена | Описание |
|------|------|----------|
| **FREE** | 0₽ | Базовые функции |
| **Premium** | 199₽/мес | Полный доступ |
| **Lifetime** | 4990₽ | Пожизненный доступ |

## Поддержка

- Документация YooKassa: [yookassa.ru/developers](https://yookassa.ru/developers)
- SDK документация: [@a2seven/yoo-checkout](https://www.npmjs.com/package/@a2seven/yoo-checkout)
